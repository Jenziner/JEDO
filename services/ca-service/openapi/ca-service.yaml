openapi: 3.0.3
info:
  title: JEDO CA Service API
  description: |
    Certificate Authority Service für Hyperledger Fabric.
    
    Ermöglicht die hierarchische Erstellung von Zertifikaten:
    - Regnum → Ager
    - Ager → Gens (X.509)
    - Gens → Human (Idemix)
    
    **Authentication:** Mutual TLS (mTLS) mit Client-Zertifikaten
  version: 1.0.0
  contact:
    name: JEDO Team
    email: support@jedo.dev
  license:
    name: MIT

servers:
  - url: https://localhost:53911
    description: Local Development (HTTPS)
  - url: https://ca.via.alps.ea.jedo.dev:53911
    description: Production Alps Ager

tags:
  - name: Certificates
    description: Certificate Lifecycle Management
  - name: Health
    description: Service Health & Monitoring

paths:
  /cainfo:
    get:
      tags:
        - Certificates
      summary: Get CA Information
      description: Returns CA server information (no authentication required)
      operationId: getCAInfo
      responses:
        '200':
          description: CA information retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CAInfoResponse'

  /certificates/register:
    post:
      tags:
        - Certificates
      summary: Register a new user
      description: |
        Registriert einen neuen Benutzer (Gens oder Human) beim CA-Server.
        
        **Authorization:**
        - Ager-Cert kann Gens registrieren
        - Gens-Cert kann Human registrieren
      operationId: registerUser
      security:
        - clientCertificate: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterUserRequest'
            examples:
              registerGens:
                summary: Register Gens
                value:
                  username: gens001.alps.ea.jedo.dev
                  secret: SecurePass123
                  role: gens
                  affiliation: jedo.ea.alps
                  attrs:
                    email: gens001@example.com
              registerHuman:
                summary: Register Human
                value:
                  username: human001.alps.ea.jedo.dev
                  secret: SecurePass456
                  role: human
                  affiliation: jedo.ea.alps
      responses:
        '200':
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterUserResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /certificates/enroll:
    post:
      tags:
        - Certificates
      summary: Enroll a user
      description: |
        Enrollt einen registrierten Benutzer:
        - **Gens:** X.509 certificate mit CSR parameters
        - **Human:** Idemix credentials für Privacy-Preserving Authentication
      operationId: enrollUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnrollUserRequest'
            examples:
              enrollGens:
                summary: Enroll Gens (X.509)
                value:
                  username: gens001.alps.ea.jedo.dev
                  secret: SecurePass123
                  role: gens
                  enrollmentType: x509
              enrollHuman:
                summary: Enroll Human (Idemix)
                value:
                  username: human001.alps.ea.jedo.dev
                  secret: SecurePass456
                  role: human
                  enrollmentType: idemix
                  idemixCurve: gurvy.Bn254
                  gensName: gens001.alps.ea.jedo.dev
      responses:
        '200':
          description: User successfully enrolled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrollUserResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /certificates/reenroll:
    post:
      tags:
        - Certificates
      summary: Re-enroll an existing user (TODO)
      deprecated: true
      description: |
        ⚠️ **NOT YET IMPLEMENTED**
        
        Re-enrollt einen existierenden Benutzer (Certificate Renewal).
        Erneuert das Zertifikat ohne neue Registration.
      operationId: reenrollUser
      security:
        - clientCertificate: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  type: string
                  example: gens001.alps.ea.jedo.dev
      responses:
        '501':
          description: Not Implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: Not implemented yet

  /certificates/revoke:
    post:
      tags:
        - Certificates
      summary: Revoke a user certificate (TODO)
      deprecated: true
      description: |
        ⚠️ **NOT YET IMPLEMENTED**
        
        Widerruft das Zertifikat eines Benutzers.
        Nur für Admin/Ager-Rollen verfügbar.
      operationId: revokeUser
      security:
        - clientCertificate: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  type: string
                  example: gens001.alps.ea.jedo.dev
                reason:
                  type: string
                  enum:
                    - unspecified
                    - keyCompromise
                    - affiliationChanged
                    - superseded
                    - cessationOfOperation
                  default: unspecified
      responses:
        '501':
          description: Not Implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: Not implemented yet

  /health:
    get:
      tags:
        - Health
      summary: Basic health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: Checks if service is ready (includes CA connectivity)
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
        '503':
          description: Service not ready

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      operationId: livenessCheck
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  securitySchemes:
    clientCertificate:
      type: mutualTLS
      description: |
        Client certificate authentication (mTLS).
        - Ager certificates can register Gens
        - Gens certificates can register Humans

  schemas:
    CAInfoResponse:
      type: object
      properties:
        success:
          type: boolean
        caName:
          type: string
          example: msp.alps.ea.jedo.dev
        caChain:
          type: string
          description: CA certificate chain (base64)
        issuerPublicKey:
          type: string
          description: Idemix issuer public key
        issuerRevocationPublicKey:
          type: string
          description: Idemix revocation public key
        version:
          type: string
          example: 1.5.7

    RegisterUserRequest:
      type: object
      required:
        - username
        - secret
        - role
        - affiliation
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 128
          description: Unique user identifier (FQDN recommended)
          example: gens001.alps.ea.jedo.dev
        secret:
          type: string
          minLength: 8
          maxLength: 64
          description: User password
          example: SecurePass123
        role:
          type: string
          enum: [gens, human]
          description: User role
        affiliation:
          type: string
          pattern: '^[a-z0-9.]+$'
          description: Organizational affiliation (dot-separated)
          example: jedo.ea.alps
        attrs:
          type: object
          additionalProperties:
            type: string
          description: Additional user attributes

    RegisterUserResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            username:
              type: string
            secret:
              type: string
              description: Secret for enrollment
            role:
              type: string
            affiliation:
              type: string

    EnrollUserRequest:
      type: object
      required:
        - username
        - secret
        - role
      properties:
        username:
          type: string
          example: gens001.alps.ea.jedo.dev
        secret:
          type: string
          description: Secret from registration
        role:
          type: string
          enum: [gens, human]
        enrollmentType:
          type: string
          enum: [x509, idemix]
          default: x509
          description: |
            - x509: For Gens (standard certificates)
            - idemix: For Humans (privacy-preserving)
        idemixCurve:
          type: string
          enum: [gurvy.Bn254, amcl.Fp256bn]
          default: gurvy.Bn254
          description: Idemix curve (only for idemix enrollment)
        gensName:
          type: string
          description: Parent Gens name (required for Humans)
          example: gens001.alps.ea.jedo.dev

    EnrollUserResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          oneOf:
            - $ref: '#/components/schemas/X509EnrollmentData'
            - $ref: '#/components/schemas/IdemixEnrollmentData'

    X509EnrollmentData:
      type: object
      properties:
        username:
          type: string
        certificate:
          type: string
          description: PEM-encoded X.509 certificate
        privateKey:
          type: string
          description: PEM-encoded private key
        rootCertificate:
          type: string
          description: CA root certificate
        role:
          type: string

    IdemixEnrollmentData:
      type: object
      properties:
        username:
          type: string
        signerConfig:
          type: string
          description: Idemix SignerConfig
        issuerPublicKey:
          type: string
        issuerRevocationPublicKey:
          type: string
        curve:
          type: string
        role:
          type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
        service:
          type: string
        timestamp:
          type: string
          format: date-time

    ReadinessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ready, not ready]
        ca:
          type: object
          properties:
            healthy:
              type: boolean
            caName:
              type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        details:
          oneOf:
            - type: string
            - type: array
              items:
                type: object

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

security:
  - clientCertificate: []
